doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Pending Pickups - RaddiWala
    link(rel="stylesheet", href="/css/style.css")
    link(rel="stylesheet", href="/css/dashboard.css")
    link(rel="stylesheet", href="/css/pickups.css")
    link(href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css", rel="stylesheet")
    style.
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background-color: white;
        padding: 0;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #eee;
      }

      .modal-header h3 {
        margin: 0;
        color: #333;
      }

      .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-close:hover {
        color: #333;
      }

      .confirm-content {
        padding: 20px;
        text-align: center;
      }

      .confirm-content p {
        margin: 0;
        color: #333;
        font-size: 16px;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding: 0 20px 20px 20px;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        text-decoration: none;
        display: inline-block;
        text-align: center;
        transition: background-color 0.2s;
      }

      .btn-primary {
        background-color: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background-color: #0056b3;
      }

      .btn-secondary {
        background-color: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #545b62;
      }
  body
    // Navigation Bar
    nav.navbar
      .nav-container
        .nav-logo(onclick="navigateToHome()") RaddiWala
        .nav-menu
          a.nav-link(href="/customer/dashboard") Dashboard
          a.nav-link(href="/customer/sell-scrap") Sell Scrap
          a.nav-link.active(href="/customer/pending-pickups") My Requests
          a.nav-link(href="/customer/completed-pickups") History
          a.nav-link(href="/customer/profile") Profile
        .nav-user
          a.nav-link(href="#", onclick="confirmLogout()") Logout

    // Main Content
    main.dashboard-content
      .container
        .page-header
          h1 Pending Pickups
          p Manage your pending pickup requests and review bids

        .pickups-container#pickupsContainer
          .loading-spinner
            i.fas.fa-spinner.fa-spin
            span Loading pending pickups...

  // Confirmation Modal
  .modal#confirmModal(style="display: none;")
    .modal-content
      .modal-header
        h3 Confirm Action
        button.modal-close(onclick="hideConfirmModal()") &times;

      .confirm-content
        p#confirmMessage

      .modal-actions
        button.btn.btn-secondary(onclick="hideConfirmModal()") Cancel
        button.btn.btn-primary#confirmButton(onclick="executeConfirmAction()") Confirm

  // Footer
  footer.footer
    .container
      .footer-bottom
        p &copy; 2025 Shail K Patel &middot; Crafted out of boredom.
        p
          a(href="https://github.com/ShailKPatel/Raddiwala", target="_blank", rel="noopener noreferrer") GitHub Repo
          span &middot; MIT License

  script(src="/js/main.js")
  script.
    let pendingRequests = [];
    let currentBidId = null;
    let currentRequestId = null;



    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        max-width: 300px;
        word-wrap: break-word;
      `;

      if (type === 'success') {
        notification.style.backgroundColor = '#28a745';
      } else if (type === 'error') {
        notification.style.backgroundColor = '#dc3545';
      } else {
        notification.style.backgroundColor = '#007bff';
      }

      document.body.appendChild(notification);

      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 5000);
    }

    // Load pending pickups
    async function loadPendingPickups() {
      try {
        console.log('Loading pending pickups...');
        showLoading();

        const response = await fetch('/api/customers/pickup-requests/pending', {
          credentials: 'include' // This ensures cookies are sent with the request
        });

        if (!response.ok) {
          if (response.status === 401) {
            window.location.href = '/login';
            return;
          }
          throw new Error('Failed to load pending pickups');
        }

        const data = await response.json();
        console.log('Loaded pending pickups:', data);
        pendingRequests = Array.isArray(data) ? data : (data.pickupRequests || []);
        console.log('Request statuses:', pendingRequests.map(r => ({ id: r._id, status: r.status, acceptedBidId: r.acceptedBidId })));
        renderPendingPickups();
      } catch (error) {
        console.error('Error loading pending pickups:', error);
        showNotification('Failed to load pending pickups', 'error');
        showEmptyState('Failed to load pending pickups');
      }
    }

    // Render pending pickups
    function renderPendingPickups() {
      console.log('Rendering pending pickups:', pendingRequests);
      const container = document.getElementById('pickupsContainer');

      if (pendingRequests.length === 0) {
        console.log('No pending requests found, showing empty state');
        showEmptyState('No pending pickups found');
        return;
      }

      // Separate requests by status
      const openRequests = pendingRequests.filter(r => r.status === 'open' || !r.status);
      const acceptedRequests = pendingRequests.filter(r => r.status === 'accepted');

      console.log('Open requests:', openRequests.length);
      console.log('Accepted requests:', acceptedRequests.length);
      console.log('All requests:', pendingRequests.map(r => ({ id: r._id, status: r.status })));

      let html = '';

      // Show accepted requests first (higher priority)
      if (acceptedRequests.length > 0) {
        console.log('Rendering accepted requests section');
        html += '<div class="section-header"><h3><i class="fas fa-handshake"></i> Accepted Bids - Awaiting Pickup</h3></div>';
        acceptedRequests.forEach(request => {
          console.log('Rendering accepted request:', request._id);
          html += renderRequestCard(request);
        });
      }

      // Show open requests
      if (openRequests.length > 0) {
        console.log('Rendering open requests section');
        html += '<div class="section-header"><h3><i class="fas fa-clock"></i> Open for Bids</h3></div>';
        openRequests.forEach(request => {
          console.log('Rendering open request:', request._id);
          html += renderRequestCard(request);
        });
      }

      console.log('Final HTML length:', html.length);
      container.innerHTML = html;
    }

    // Render individual request card
    function renderRequestCard(request) {
        console.log('renderRequestCard called for:', request._id, 'status:', request.status);
        console.log('Request bids:', request.bids);
        const bids = request.bids || [];
        const photos = request.photos || [];

        // Debug bid structure
        if (bids.length > 0) {
          console.log('First bid structure:', bids[0]);
          console.log('RaddiWala data:', bids[0].raddiwalaId);
          console.log('RaddiWala name:', bids[0].raddiwalaId?.name);
          console.log('RaddiWala ratings:', bids[0].raddiwalaId?.ratings);
          console.log('Total estimated amount:', bids[0].totalEstimatedAmount);
        }

        // Debug accepted bid data
        if (request.status === 'accepted') {
          console.log('Request acceptedBidId:', request.acceptedBidId);
          console.log('Request acceptedBidId type:', typeof request.acceptedBidId);
          console.log('Available bid IDs:', bids.map(b => b._id));
          console.log('Bids isAccepted status:', bids.map(b => ({ id: b._id, isAccepted: b.isAccepted })));

          if (request.acceptedBidId) {
            console.log('Accepted bid data:', request.acceptedBidId);
            console.log('Accepted RaddiWala:', request.acceptedBidId.raddiwalaId);
          }
        }

        const cardHtml = '<div class="pickup-card">' +
            '<div class="pickup-header">' +
              '<div class="pickup-info">' +
                '<h3>' + (Array.isArray(request.wasteType) ? request.wasteType.join(', ') : request.wasteType) + '</h3>' +
                '<p class="weight">' + (request.weightCategory || 'Weight not specified') + '</p>' +
                '<p class="location">' +
                  [request.addressId?.area, request.addressId?.city].filter(Boolean).join(', ') +
                '</p>' +
              '</div>' +
              '<div class="pickup-status">' +
                '<span class="status-badge ' + (request.status || 'pending') + '">' +
                  (request.status === 'open' ? 'Open for Bids' :
                   request.status === 'accepted' ? 'Bid Accepted' :
                   request.status ? request.status.charAt(0).toUpperCase() + request.status.slice(1) : 'Pending') +
                '</span>' +
                '<p class="created-date">Created: ' + new Date(request.createdAt).toLocaleDateString() + '</p>' +
                (request.status === 'accepted' && request.statusTimestamps?.acceptedAt ?
                  '<p class="accepted-date">Accepted: ' + new Date(request.statusTimestamps.acceptedAt).toLocaleDateString() + '</p>' : '') +
              '</div>' +
            '</div>' +

            '<div class="pickup-details">' +
              (request.description ? '<p><strong>Description:</strong> ' + request.description + '</p>' : '') +
              (request.timeWindow ? '<p><strong>Preferred Time:</strong> ' + request.timeWindow + '</p>' : '') +
              '<p><strong>Address:</strong> ' +
                [request.addressId?.streetAddress, request.addressId?.area, request.addressId?.city].filter(Boolean).join(', ') +
              '</p>' +
            '</div>' +

            (photos.length > 0 ?
              '<div class="pickup-photos">' +
                '<h4>Photos (' + photos.length + '):</h4>' +
                '<div class="photos-grid">' +
                  photos.slice(0, 3).map(photo =>
                    '<img src="' + photo + '" alt="Scrap photo" onclick="showImageModal(\'' + photo + '\')">'
                  ).join('') +
                  (photos.length > 3 ? '<div class="more-photos">+' + (photos.length - 3) + ' more</div>' : '') +
                '</div>' +
              '</div>' : ''
            ) +

            '<div class="bids-section">' +
              (request.status === 'accepted' && request.acceptedBidId ?
                // For accepted requests - show only the accepted bid with cancel option
                '<h4>Selected RaddiWala:</h4>' +
                (function() {
                  // Try multiple ways to find the accepted bid
                  let acceptedBid = bids.find(bid => bid._id === request.acceptedBidId);

                  // If not found by ID, try finding by isAccepted flag
                  if (!acceptedBid) {
                    acceptedBid = bids.find(bid => bid.isAccepted === true);
                  }

                  // If still not found, try string comparison (in case of type mismatch)
                  if (!acceptedBid && request.acceptedBidId) {
                    acceptedBid = bids.find(bid => bid._id.toString() === request.acceptedBidId.toString());
                  }

                  console.log('Found accepted bid:', acceptedBid);

                  if (!acceptedBid) {
                    console.error('Could not find accepted bid. Request acceptedBidId:', request.acceptedBidId, 'Available bids:', bids.map(b => b._id));
                    return '<p class="no-bids">Selected bid information not available.</p>';
                  }

                  return '<div class="accepted-bid-container">' +
                    '<div class="bid-item accepted-bid">' +
                      '<div class="bid-info">' +
                        '<div class="raddiwala-info">' +
                          '<strong>' + (acceptedBid.raddiwalaId?.name || 'RaddiWala') + '</strong>' +
                          '<p>⭐ ' + (acceptedBid.raddiwalaId?.ratings?.avgRating || 4.2).toFixed(1) + '/5' +
                          ' (' + (acceptedBid.raddiwalaId?.ratings?.totalRatings || 12) + ' reviews)</p>' +
                        '</div>' +
                        '<div class="bid-details">' +
                          '<p><strong>Total Amount:</strong> ₹' + (acceptedBid.totalEstimatedAmount || acceptedBid.amount || 0) + '</p>' +
                          '<p><strong>Pickup Time:</strong> ' + (acceptedBid.proposedPickupTime || 'To be confirmed') + '</p>' +
                          (acceptedBid.notes && acceptedBid.notes.trim() ? '<p><strong>Notes:</strong> ' + acceptedBid.notes + '</p>' : '') +
                        '</div>' +
                      '</div>' +
                      '<div class="bid-actions">' +
                        '<span class="bid-status accepted">✓ Accepted - Awaiting Pickup</span>' +
                      '</div>' +
                    '</div>' +
                  '</div>';
                })() :
                // For open requests - show all bids with accept buttons
                '<h4>Bids Received (' + bids.length + '):</h4>' +
                (bids.length > 0 ?
                  '<div class="bids-list">' +
                    bids.map(bid =>
                      '<div class="bid-item">' +
                        '<div class="bid-info">' +
                          '<div class="raddiwala-info">' +
                            '<strong>' + (bid.raddiwalaId?.name || 'RaddiWala') + '</strong>' +
                            '<p>⭐ ' + (bid.raddiwalaId?.ratings?.avgRating || 4.2).toFixed(1) + '/5' +
                            ' (' + (bid.raddiwalaId?.ratings?.totalRatings || 12) + ' reviews)</p>' +
                          '</div>' +
                          '<div class="bid-details">' +
                            '<p><strong>Total Amount:</strong> ₹' + (bid.totalEstimatedAmount || bid.amount || 0) + '</p>' +
                            '<p><strong>Pickup Time:</strong> ' + (bid.proposedPickupTime || 'To be confirmed') + '</p>' +
                            (bid.notes && bid.notes.trim() ? '<p><strong>Notes:</strong> ' + bid.notes + '</p>' : '') +
                          '</div>' +
                        '</div>' +
                        '<div class="bid-actions">' +
                          '<button class="btn btn-primary" onclick="acceptBid(\'' + bid._id + '\', \'' + request._id + '\')">Accept Bid</button>' +
                        '</div>' +
                      '</div>'
                    ).join('') +
                  '</div>' :
                  '<p class="no-bids">No bids received yet. RaddiWalas will bid on your request soon.</p>'
                )
              ) +
            '</div>' +
          '</div>';

        console.log('Generated card HTML length:', cardHtml.length);
        return cardHtml;
    }

    // Show loading state
    function showLoading() {
      console.log('Showing loading state');
      const container = document.getElementById('pickupsContainer');
      container.innerHTML = '<div class="loading" style="text-align: center; padding: 40px; color: #6c757d;">Loading pending pickups...</div>';
    }

    // Show empty state
    function showEmptyState(message) {
      const container = document.getElementById('pickupsContainer');
      container.innerHTML =
        '<div class="empty-state" style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">' +
          '<h3 style="color: #6c757d; margin-bottom: 15px;">' + message + '</h3>' +
          '<p style="color: #6c757d; margin-bottom: 20px;">Create a new pickup request to get started</p>' +
          '<a href="/customer/sell-scrap" class="btn btn-primary" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block;">Sell Scrap Now</a>' +
        '</div>';
    }

    // Accept bid function
    function acceptBid(bidId, requestId) {
      console.log('=== ACCEPT BID CLICKED ===');
      console.log('acceptBid called with:', { bidId, requestId });
      const bid = findBidById(bidId);
      if (!bid) {
        console.error('Bid not found:', bidId);
        showNotification('Bid not found', 'error');
        return;
      }

      currentBidId = bidId;
      currentRequestId = requestId;

      const raddiWalaName = bid.raddiWalaId?.name || 'Unknown RaddiWala';
      const confirmMessage = `Are you sure you want to accept the bid from ${raddiWalaName}? This action cannot be undone.`;
      console.log('Setting confirm message:', confirmMessage);

      const confirmMessageEl = document.getElementById('confirmMessage');
      const confirmModal = document.getElementById('confirmModal');

      if (!confirmMessageEl || !confirmModal) {
        console.error('Modal elements not found');
        alert('Modal not found. Please refresh the page.');
        return;
      }

      confirmMessageEl.textContent = confirmMessage;
      confirmModal.style.display = 'flex';
      confirmModal.classList.add('show');
      console.log('Modal should be visible now');
    }

    // Find bid by ID
    function findBidById(bidId) {
      console.log('Finding bid with ID:', bidId);
      console.log('Available requests:', pendingRequests.length);

      for (const request of pendingRequests) {
        console.log('Checking request:', request._id, 'with bids:', request.bids?.length || 0);
        const bid = request.bids?.find(b => b._id === bidId);
        if (bid) {
          console.log('Found bid:', bid);
          return bid;
        }
      }
      console.log('Bid not found');
      return null;
    }

    // Execute confirm action
    async function executeConfirmAction() {
      if (currentBidId === 'logout') {
        window.location.href = '/logout';
      } else if (currentBidId && currentRequestId) {
        await confirmAcceptBid(currentBidId, currentRequestId);
      }
      hideConfirmModal();
    }

    // Confirm accept bid
    async function confirmAcceptBid(bidId, requestId) {
      try {
        console.log('Accepting bid:', bidId, 'for request:', requestId);

        // Show loading state
        const confirmButton = document.getElementById('confirmButton');
        if (confirmButton) {
          confirmButton.disabled = true;
          confirmButton.textContent = 'Accepting...';
        }

        const response = await fetch(`/api/pickup-requests/${requestId}/accept-bid`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include', // This ensures cookies are sent with the request
          body: JSON.stringify({ bidId })
        });

        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);

        if (!response.ok) {
          if (response.status === 401) {
            console.log('Unauthorized - redirecting to login');
            window.location.href = '/login';
            return;
          }

          let errorMessage = 'Failed to accept bid';
          try {
            const error = await response.json();
            errorMessage = error.message || errorMessage;
            console.error('Server error:', error);
          } catch (parseError) {
            console.error('Failed to parse error response:', parseError);
            errorMessage = `Server error: ${response.status} ${response.statusText}`;
          }

          throw new Error(errorMessage);
        }

        const result = await response.json();
        console.log('Success response:', result);

        if (typeof showNotification === 'function') {
          showNotification('Bid accepted successfully!', 'success');
        } else if (typeof RaddiWala !== 'undefined' && RaddiWala.showNotification) {
          RaddiWala.showNotification('Bid accepted successfully!', 'success');
        } else {
          alert('Bid accepted successfully!');
        }

        hideConfirmModal();
        console.log('Reloading pending pickups after bid acceptance...');

        // Add a small delay to ensure database is updated
        setTimeout(() => {
          loadPendingPickups(); // Reload to update the list
        }, 1000);

      } catch (error) {
        console.error('Error accepting bid:', error);
        if (typeof showNotification === 'function') {
          showNotification(error.message || 'Failed to accept bid', 'error');
        } else if (typeof RaddiWala !== 'undefined' && RaddiWala.showNotification) {
          RaddiWala.showNotification(error.message || 'Failed to accept bid', 'error');
        } else {
          alert('Error: ' + (error.message || 'Failed to accept bid'));
        }
      } finally {
        // Reset button state
        const confirmButton = document.getElementById('confirmButton');
        if (confirmButton) {
          confirmButton.disabled = false;
          confirmButton.textContent = 'Confirm';
        }
      }
    }

    // Show image modal
    function showImageModal(imageSrc) {
      window.open(imageSrc, '_blank');
    }

    // Confirmation modal functions
    function hideConfirmModal() {
      const modal = document.getElementById('confirmModal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
      currentBidId = null;
      currentRequestId = null;
    }



    // Logout confirmation
    function confirmLogout() {
      document.getElementById('confirmMessage').textContent = 'Are you sure you want to logout?';
      currentBidId = 'logout';
      currentRequestId = null;
      const modal = document.getElementById('confirmModal');
      modal.style.display = 'flex';
      modal.classList.add('show');
    }

    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      const modal = document.getElementById('confirmModal');
      if (event.target === modal) {
        hideConfirmModal();
      }
    });

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      // Ensure modals are hidden on page load
      const confirmModal = document.getElementById('confirmModal');
      if (confirmModal) {
        confirmModal.style.display = 'none';
      }

      loadPendingPickups();
    });
