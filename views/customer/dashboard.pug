doctype html
html(lang="en")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Customer Dashboard - RaddiWala
    link(rel="stylesheet", href="/css/style.css")
    link(rel="stylesheet", href="/css/dashboard.css")
    link(href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css", rel="stylesheet")
  body
    // Navigation Bar
    nav.navbar
      .nav-container
        .nav-logo(onclick="navigateToHome()") RaddiWala
        .nav-menu
          a.nav-link.active(href="/customer/dashboard") Dashboard
          a.nav-link(href="/customer/sell-scrap") Sell Scrap
          a.nav-link(href="/customer/pending-pickups") My Requests
          a.nav-link(href="/customer/completed-pickups") History
          a.nav-link(href="/customer/profile") Profile
        .nav-user
          a.nav-link(href="#", onclick="confirmLogout()") Logout

    // Main Content
    main.dashboard-content
      .container
        .hero
          .hero-content
            h1.hero-title Customer Dashboard
            p.hero-description Welcome back, #{user.name}! Ready to sell some scrap?

        // Quick Stats
        .dashboard-grid
          .stat-card
            .stat-number#totalRequests 0
            .stat-label Total Requests
          .stat-card
            .stat-number#pendingRequests 0
            .stat-label Pending Requests
          .stat-card
            .stat-number#completedRequests 0
            .stat-label Completed Requests
          .stat-card
            .stat-number#totalEarnings ₹0
            .stat-label Total Earnings

        // Quick Actions
        .quick-actions
          h2.section-title Quick Actions
          .action-grid
            .action-card(onclick="window.location.href='/customer/sell-scrap'", style="cursor: pointer;")
              .action-icon
                i.fas.fa-camera(title="Camera")
              h3 Sell Scrap
              p Upload photos and create a new pickup request

            .action-card(onclick="window.location.href='/customer/pending-pickups'", style="cursor: pointer;")
              .action-icon
                i.fas.fa-hourglass-half(title="Pending")
              h3 View Pending Pickups
              p Check and manage your pending pickup requests

            .action-card(onclick="window.location.href='/customer/completed-pickups'", style="cursor: pointer;")
              .action-icon
                i.fas.fa-check-circle(title="Completed")
              h3 View Completed Pickups
              p Review your completed transactions and rate raddiwalas

            .action-card(onclick="window.location.href='/customer/profile'", style="cursor: pointer;")
              .action-icon
                i.fas.fa-user-cog(title="Profile")
              h3 Manage Profile
              p Update your profile and manage addresses

        // Recent Activity
        .recent-activity
          h2.section-title Recent Activity
          .activity-container#recentActivity
            .card
              .loading-spinner
                i.fas.fa-spinner.fa-spin
                span Loading recent activity...

    // Footer
    footer.footer
      .container
        .footer-bottom
          p &copy; 2025 Shail K Patel &middot; Crafted out of boredom.
          p
            a(href="https://github.com/ShailKPatel/Raddiwala", target="_blank", rel="noopener noreferrer") GitHub Repo
            span &middot; MIT License

    script(src="/js/main.js")
    script.
      function confirmLogout() {
        if (confirm('Are you sure you want to logout?')) {
          window.location.href = '/logout';
        }
      }
    script.
      // Load dashboard data
      async function loadDashboardData() {
        try {
          // Load stats
          const [requestsResponse, transactionsResponse] = await Promise.all([
            fetch('/api/customers/pickup-requests', { credentials: 'include' }),
            fetch('/api/customers/completed-transactions', { credentials: 'include' })
          ]);

          if (!requestsResponse.ok || !transactionsResponse.ok) {
            throw new Error('Failed to load dashboard data');
          }

          const requests = await requestsResponse.json();
          const transactions = await transactionsResponse.json();

          console.log('Dashboard requests:', requests);
          console.log('Dashboard transactions:', transactions);

          // Update stats
          document.getElementById('totalRequests').textContent = Array.isArray(requests) ? requests.length : 0;
          document.getElementById('pendingRequests').textContent = Array.isArray(requests) ?
            requests.filter(r => r.status === 'open' || r.status === 'accepted').length : 0;
          document.getElementById('completedRequests').textContent = Array.isArray(requests) ?
            requests.filter(r => r.status === 'completed').length : 0;
          
          const totalEarnings = transactions.reduce((sum, t) => sum + t.totalAmount, 0);
          document.getElementById('totalEarnings').textContent = 
            RaddiWala.formatCurrency(totalEarnings);

          // Load recent activity
          loadRecentActivity(requests, transactions);

        } catch (error) {
          console.error('Failed to load dashboard data:', error);
          RaddiWala.showNotification('Failed to load dashboard data', 'error');
        }
      }

      function loadRecentActivity(requests, transactions) {
        const activityContainer = document.getElementById('recentActivity');
        
        // Combine and sort recent items
        const recentItems = [];
        
        // Add recent requests
        requests.slice(0, 3).forEach(request => {
          recentItems.push({
            type: 'request',
            date: new Date(request.createdAt),
            data: request
          });
        });

        // Add recent transactions
        transactions.slice(0, 3).forEach(transaction => {
          recentItems.push({
            type: 'transaction',
            date: new Date(transaction.completedAt),
            data: transaction
          });
        });

        // Sort by date
        recentItems.sort((a, b) => b.date - a.date);

        if (recentItems.length === 0) {
          activityContainer.innerHTML = `
            <div class="no-activity">
              <i class="fas fa-info-circle"></i>
              <p>No recent activity. Start by creating your first pickup request!</p>
              <a href="/customer/sell-scrap" class="btn btn-primary">Sell Scrap Now</a>
            </div>
          `;
          return;
        }

        // Render recent items
        const activityHTML = recentItems.slice(0, 5).map(item => {
          if (item.type === 'request') {
            return `
              <div class="activity-item">
                <div class="activity-icon request">
                  <i class="fas fa-upload"></i>
                </div>
                <div class="activity-content">
                  <h4>Pickup Request Created</h4>
                  <p>${item.data.wasteType} - ${item.data.weightCategory}</p>
                  <span class="activity-date">${RaddiWala.formatDate(item.date)}</span>
                </div>
                <div class="activity-status status-${item.data.status}">
                  ${item.data.status.charAt(0).toUpperCase() + item.data.status.slice(1)}
                </div>
              </div>
            `;
          } else {
            return `
              <div class="activity-item">
                <div class="activity-icon transaction">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="activity-content">
                  <h4>Transaction Completed</h4>
                  <p>Amount: ${RaddiWala.formatCurrency(item.data.totalAmount)}</p>
                  <span class="activity-date">${RaddiWala.formatDate(item.date)}</span>
                </div>
                <div class="activity-rating">
                  ${item.data.customerRating && item.data.customerRating.rating ?
                    `<div class="rating">${'★'.repeat(item.data.customerRating.rating)}${'☆'.repeat(5-item.data.customerRating.rating)}</div>` :
                    '<span class="no-rating">Not rated</span>'
                  }
                </div>
              </div>
            `;
          }
        }).join('');

        activityContainer.innerHTML = activityHTML;
      }

      // Load data when page loads
      document.addEventListener('DOMContentLoaded', loadDashboardData);
